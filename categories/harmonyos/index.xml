<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>HarmonyOS - 分类 - Leeshy&#39;s Blog | To be humble</title>
        <link>https://leeshy-tech.github.io/categories/harmonyos/</link>
        <description>HarmonyOS - 分类 - Leeshy&#39;s Blog | To be humble</description>
        <generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>saili@bupt.edu.cn (Leeshy)</managingEditor>
            <webMaster>saili@bupt.edu.cn (Leeshy)</webMaster><lastBuildDate>Tue, 08 Feb 2022 21:26:06 &#43;0800</lastBuildDate><atom:link href="https://leeshy-tech.github.io/categories/harmonyos/" rel="self" type="application/rss+xml" /><item>
    <title>鸿蒙开发笔记——Ability</title>
    <link>https://leeshy-tech.github.io/harmonyos_ability/</link>
    <pubDate>Tue, 08 Feb 2022 21:26:06 &#43;0800</pubDate><author>saili@bupt.edu.cn (Leeshy)</author><guid>https://leeshy-tech.github.io/harmonyos_ability/</guid>
    <description><![CDATA[<h1 id="ability">Ability</h1>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw"></i>HarmonyOS文档<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Ability是应用所具备能力的抽象，也是应用程序的重要组成部分。一个应用可以具备多种能力，HarmonyOS支持应用以Ability为单位进行部署。Ability可以分为FA（Feature Ability）和PA（Particle Ability）两种类型，每种类型为开发者提供了不同的模板，以便实现不同的业务功能。</div>
        </div>
    </div>
<p>总的来说，Ability是功能相似的内容的集合，这种划分便于应用的编程组织，FA提供与用户交互的能力，只包含PageAbility，PA没有可视化界面，包括ServiceAbility和DataAbility。</p>
<h2 id="配置">配置</h2>
<p>一个应用中所有的Ability必须在config.json中注册。</p>
<p>如果通过新建Ability来创建Ability，Studio会自动注册，不需要手动更改config.json。</p>
<p>但如果通过新建Java类来创建，则需要在config.json添加相关的配置信息。</p>
<p></p>
<p>同样，当删除Ability时，需要删除config.json中对应的配置信息，否则会出现一些问题。</p>
<h2 id="生命周期">生命周期</h2>
<p>PageAbility和ServiceAbility具有复杂的生命周期，创建、隐藏到后台、从后台呼出等等都会执行相关的生命周期函数，其中onStart方法最常用，当Ability创建时调用onStart方法，所以UI的绑定、按钮事件响应器等等都需要在onStart方法中实现。</p>
<p></p>
<h2 id="intent">Intent</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw"></i>HarmonyOS文档<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Intent是对象之间传递信息的载体。例如，当一个Ability需要启动另一个Ability时，或者一个AbilitySlice需要导航到另一个AbilitySlice时，可以通过Intent指定启动的目标同时携带相关数据。</div>
        </div>
    </div>
<p>Intent是页面跳转及传参的关键，他包括Operation与Parameters两个属性，不传参时只需要构造默认intent，例如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">btn1</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">component</span> <span class="o">-&gt;</span> <span class="o">{</span>
 	<span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
 	<span class="k">this</span><span class="o">.</span><span class="na">present</span><span class="o">(</span><span class="k">new</span> <span class="n">SecondAbilitySlice</span><span class="o">(),</span><span class="n">intent</span><span class="o">);</span>
 <span class="o">});</span>
</code></pre></div><p>参数通过Parameters来传递：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">btn1</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">component</span> <span class="o">-&gt;</span> <span class="o">{</span>
     <span class="n">Intent</span> <span class="n">intent1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
     <span class="n">intent1</span><span class="o">.</span><span class="na">setParam</span><span class="o">(</span><span class="s">&#34;productId&#34;</span><span class="o">,</span><span class="s">&#34;101&#34;</span><span class="o">);</span>
     <span class="k">this</span><span class="o">.</span><span class="na">present</span><span class="o">(</span><span class="k">new</span> <span class="n">SecondAbilitySlice</span><span class="o">(),</span><span class="n">intent1</span><span class="o">);</span>
 <span class="o">});</span>
</code></pre></div><p>通过设置Operation可以启动任意<strong>设备</strong>的任意<strong>应用</strong>的任意<strong>Ability</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
<span class="c1">// 通过Intent中的OperationBuilder类构造operation对象，指定设备标识（空串表示当前设备）、应用包名、Ability名称
</span><span class="c1"></span><span class="n">Operation</span> <span class="n">operation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">.</span><span class="na">OperationBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">withDeviceId</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withBundleName</span><span class="o">(</span><span class="s">&#34;com.demoapp&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withAbilityName</span><span class="o">(</span><span class="s">&#34;com.demoapp.FooAbility&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="c1">// 把operation设置到intent中
</span><span class="c1"></span><span class="n">intent</span><span class="o">.</span><span class="na">setOperation</span><span class="o">(</span><span class="n">operation</span><span class="o">);</span>
<span class="n">startAbility</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</code></pre></div><h2 id="pageability">PageAbility</h2>
<p>一个PageAbility可以包含任意个AbilitySlice，默认展示的AbilitySlice是通过**setMainRoute()**方法来指定的。</p>
<h3 id="abilityslice">AbilitySlice</h3>
<p>AbilitySlice相当于一个页面，其显示的内容是通过组件来声明的，其组件加载⽀持两种⽅式：</p>
<ul>
<li>Java代码</li>
<li>xml布局文件</li>
</ul>
<p>在其onStart方法中通过 setUIContext 来加载视图组件，它有两个重载：</p>
<ul>
<li>setUIContext(int) : 通过布局⽂件的ID，加载resources/base/layout⽬录下的布局⽂件完成⻚⾯的渲染。</li>
<li>setUIContext(ComponentContainer) :通过加载⼀个使⽤Java代码创建的组件完成⻚⾯的渲染 。</li>
</ul>
<h2 id="serviceability">ServiceAbility</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw"></i>HarmonyOS文档<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">基于Service模板的Ability（以下简称“Service”）主要用于后台运行任务（如执行音乐播放、文件下载等），但不提供用户交互界面。Service可由其他应用或Ability启动，即使用户切换到其他应用，Service仍将在后台继续运行。</div>
        </div>
    </div>
<h3 id="前台service">前台Service</h3>
<p>一般情况下，Service都是在后台运行的，后台Service的优先级都是比较低的，当资源不足时，系统有可能回收正在运行的后台Service。</p>
<p>在一些场景下（如播放音乐），用户希望应用能够一直保持运行，此时就需要使用前台Service。前台Service会始终保持正在运行的图标在系统状态栏显示。</p>
<h2 id="dataability">DataAbility</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw"></i>HarmonyOS文档<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>使用Data模板的Ability（以下简称“Data”）有助于应用管理其自身和其他应用存储数据的访问，并提供与其他应用共享数据的方法。Data既可用于同设备不同应用的数据共享，也支持跨设备不同应用的数据共享。</p>
<p>数据的存放形式多样，可以是数据库，也可以是磁盘上的文件。Data对外提供对数据的增、删、改、查，以及打开文件等接口，这些接口的具体实现由开发者提供</p>
</div>
        </div>
    </div>
<h3 id="uri">URI</h3>
<p>URI用来标识一个具体的数据，例如数据库中的某个表或磁盘上的某个文件。格式如下：</p>
<p></p>
<ul>
<li>scheme：协议方案名，固定为“dataability”，代表Data Ability所使用的协议类型。</li>
<li>authority：设备ID。如果为跨设备场景，则为目标设备的ID；如果为本地设备场景，则不需要填写。</li>
<li>path：资源的路径信息，代表特定资源的位置信息。</li>
<li>query：查询参数。</li>
<li>fragment：可以用于指示要访问的子资源。</li>
</ul>
<p>URI示例：</p>
<ul>
<li>跨设备场景：dataability://<em>device_id</em>/<em>com.domainname.dataability.persondata</em>/<em>person</em>/<em>10</em></li>
<li>本地设备：dataability:///<em>com.domainname.dataability.persondata</em>/<em>person</em>/<em>10</em></li>
</ul>
<h3 id="数据操作">数据操作</h3>
<p>DataAbility可以对文件或数据库进行数据操纵，不同类型数据管理方式写法都不一样，详见文档的<strong>数据管理</strong>一栏：</p>
<p></p>
<h2 id="实践工程">实践工程</h2>
<p><a href="https://leeshy-tech.github.io/harmonyos_pagetopage/" target="_blank" rel="noopener noreffer">页面导航</a></p>
<p><a href="https://leeshy-tech.github.io/harmonyos_serviceability/" target="_blank" rel="noopener noreffer">ServiceAbility</a></p>
<p><a href="https://leeshy-tech.github.io/harmonyos_addressbook/" target="_blank" rel="noopener noreffer">电话簿</a></p>
<h2 id="结束语">结束语</h2>
<p>本文仅是对官方文档做一个简单的总结+个人理解，详细的内容还需参考官方文档。</p>
<h3 id="参考文献">参考文献</h3>
<p><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/document-outline-0000001064589184" target="_blank" rel="noopener noreffer">HarmonyOS——文档</a></p>
]]></description>
</item>
<item>
    <title>鸿蒙开发实践——电话簿</title>
    <link>https://leeshy-tech.github.io/harmonyos_addressbook/</link>
    <pubDate>Tue, 08 Feb 2022 21:12:06 &#43;0800</pubDate><author>saili@bupt.edu.cn (Leeshy)</author><guid>https://leeshy-tech.github.io/harmonyos_addressbook/</guid>
    <description><![CDATA[<h1 id="电话簿">电话簿</h1>
<h2 id="项目简介">项目简介</h2>
<h3 id="项目结构">项目结构</h3>
<pre tabindex="0"><code>├─ entry.src.main
	├─ com.example.address_book
        ├─slice
            ├─ UserAddSlice
            ├─ UserListSlice
            └─ MainAbilitySlice
        ├─ DataBaseAbility	
        ├─ MainAbility
        └─ MyApplication
	└─ resources.base.layout
        ├─ ability_main.xml
        ├─ user_add.xml
        └─ user_list.xml
</code></pre><h3 id="效果">效果</h3>
<p></p>
<h2 id="数据库结构">数据库结构</h2>
<ul>
<li>数据库UserStore：本地、关系型
<ul>
<li>表users
<ul>
<li>属性userId：int、主键、自增</li>
<li>属性userName：text、不为空</li>
<li>属性userTel：text、唯一</li>
<li>属性userAddr：text</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="mainabilityslice">MainAbilitySlice</h2>
<p>核心代码：</p>
<p><strong>MainAbilitySlice的onStart方法：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">Button</span> <span class="n">btn1</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn1</span><span class="o">);</span>
<span class="n">btn1</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">present</span><span class="o">(</span><span class="k">new</span> <span class="n">UserAddSlice</span><span class="o">(),</span><span class="k">new</span> <span class="n">Intent</span><span class="o">()));</span>

<span class="n">Button</span> <span class="n">btn2</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn2</span><span class="o">);</span>
<span class="n">btn2</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">present</span><span class="o">(</span><span class="k">new</span> <span class="n">UserListSlice</span><span class="o">(),</span><span class="k">new</span> <span class="n">Intent</span><span class="o">()));</span>
</code></pre></div><p>执行简单的页面跳转。</p>
<h2 id="databaseability">DataBaseAbility</h2>
<p>核心代码：</p>
<p><strong>DataBaseAbility类：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">RdbStore</span> <span class="n">rdbStore</span><span class="o">;</span>
<span class="kd">private</span> <span class="n">StoreConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">StoreConfig</span><span class="o">.</span><span class="na">newDefaultConfig</span><span class="o">(</span><span class="s">&#34;UserStore.db&#34;</span><span class="o">);</span>
</code></pre></div><p>RdbStore对象：表示与数据库的连接，通过此对象可以完成对数据表中数据的CRUD操作
StoreConfig对象：关联数据⽂件配置(数据库)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">RdbOpenCallback</span> <span class="n">callback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RdbOpenCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">RdbStore</span> <span class="n">rdbStore</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//使⽤rdbStore对象执⾏SQL创建数据表
</span><span class="c1"></span>        <span class="n">rdbStore</span><span class="o">.</span><span class="na">executeSql</span><span class="o">(</span><span class="s">&#34;create table if not exists users(&#34;</span> <span class="o">+</span>
                <span class="s">&#34;userId integer primary key autoincrement,&#34;</span> <span class="o">+</span>
                <span class="s">&#34;userName text not null,&#34;</span> <span class="o">+</span>
                <span class="s">&#34;userTel text not null unique,&#34;</span> <span class="o">+</span>
                <span class="s">&#34;userAddr text)&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre></div><p>RdbOpenCallback.onCreate()：数据库创建时被回调，初始化，创建数据表users（当其不存在时）。</p>
<p><strong>DataBaseAbility类的onStart方法：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="n">HiLog</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">LABEL_LOG</span><span class="o">,</span> <span class="s">&#34;DataBaseAbility onStart&#34;</span><span class="o">);</span>

    <span class="c1">//初始化与数据库的连接
</span><span class="c1"></span>    <span class="n">DatabaseHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DatabaseHelper</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">rdbStore</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">getRdbStore</span><span class="o">(</span><span class="n">config</span><span class="o">,</span><span class="n">1</span><span class="o">,</span><span class="n">callback</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>重写insert方法：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">ValuesBucket</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">getLastPath</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="s">&#34;users&#34;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">path</span><span class="o">)){</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">rdbStore</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="s">&#34;users&#34;</span><span class="o">,</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p><strong>重写query、delete、update方法：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">ResultSet</span> <span class="nf">query</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">columns</span><span class="o">,</span> <span class="n">DataAbilityPredicates</span> <span class="n">predicates</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">RdbPredicates</span> <span class="n">rdbPredicates</span> <span class="o">=</span> <span class="n">DataAbilityUtils</span><span class="o">.</span><span class="na">createRdbPredicates</span><span class="o">(</span><span class="n">predicates</span><span class="o">,</span> <span class="s">&#34;users&#34;</span><span class="o">);</span>
    <span class="n">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">rdbStore</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">rdbPredicates</span><span class="o">,</span> <span class="n">columns</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">resultSet</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">DataAbilityPredicates</span> <span class="n">predicates</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">RdbPredicates</span> <span class="n">rdbPredicates</span> <span class="o">=</span> <span class="n">DataAbilityUtils</span><span class="o">.</span><span class="na">createRdbPredicates</span><span class="o">(</span><span class="n">predicates</span><span class="o">,</span> <span class="s">&#34;users&#34;</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">rdbStore</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">rdbPredicates</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">ValuesBucket</span> <span class="n">value</span><span class="o">,</span> <span class="n">DataAbilityPredicates</span> <span class="n">predicates</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">RdbPredicates</span> <span class="n">rdbPredicates</span> <span class="o">=</span> <span class="n">DataAbilityUtils</span><span class="o">.</span><span class="na">createRdbPredicates</span><span class="o">(</span><span class="n">predicates</span><span class="o">,</span> <span class="s">&#34;users&#34;</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">rdbStore</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">rdbPredicates</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h2 id="useraddslice">UserAddSlice</h2>
<p>核心代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserAddSlice</span> <span class="kd">extends</span> <span class="n">AbilitySlice</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">DataAbilityHelper</span> <span class="n">dataAbilityHelper</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setUIContent</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Layout_user_add</span><span class="o">);</span>
        <span class="n">dataAbilityHelper</span> <span class="o">=</span> <span class="n">DataAbilityHelper</span><span class="o">.</span><span class="na">creator</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="c1">//获取组件对象
</span><span class="c1"></span>        <span class="n">Button</span> <span class="n">btn_add</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn_add</span><span class="o">);</span>
        <span class="n">TextField</span> <span class="n">tf1</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextField</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_textField1</span><span class="o">);</span>
        <span class="n">TextField</span> <span class="n">tf2</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextField</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_textField2</span><span class="o">);</span>
        <span class="n">TextField</span> <span class="n">tf3</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextField</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_textField3</span><span class="o">);</span>
        <span class="c1">//绑定事件监听器
</span><span class="c1"></span>        <span class="n">btn_add</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">component</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">tf1</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">userTel</span> <span class="o">=</span> <span class="n">tf2</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">userAddr</span> <span class="o">=</span> <span class="n">tf3</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
            <span class="c1">//构造VB
</span><span class="c1"></span>            <span class="n">ValuesBucket</span> <span class="n">valuesBucket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ValuesBucket</span><span class="o">();</span>
            <span class="n">valuesBucket</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&#34;userName&#34;</span><span class="o">,</span><span class="n">userName</span><span class="o">);</span>
            <span class="n">valuesBucket</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&#34;userTel&#34;</span><span class="o">,</span><span class="n">userTel</span><span class="o">);</span>
            <span class="n">valuesBucket</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&#34;userAddr&#34;</span><span class="o">,</span><span class="n">userAddr</span><span class="o">);</span>
            <span class="c1">//插入数据
</span><span class="c1"></span>            <span class="k">try</span><span class="o">{</span>
                <span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&#34;dataability:///com.example.address_book.DataBaseAbility/users&#34;</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">dataAbilityHelper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span><span class="n">valuesBucket</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;------------&gt;&gt;&gt;&gt;&gt;&gt;&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">DataAbilityRemoteException</span> <span class="n">e</span><span class="o">){</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>
<p>数据库的相关操作要依靠dataAbilityHelper。</p>
</li>
<li>
<p>从TextField组件中获取输入的信息。</p>
</li>
<li>
<p>设置监听器，将获得的信息插入数据表。</p>
</li>
<li>
<p>插入数据通过ValuesBucket储存，指数据表的一行。</p>
</li>
</ul>
<h2 id="userlistslice">UserListSlice</h2>
<p>核心代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserListSlice</span> <span class="kd">extends</span> <span class="n">AbilitySlice</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">DataAbilityHelper</span> <span class="n">dataAbilityHelper</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setUIContent</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Layout_user_list</span><span class="o">);</span>

        <span class="n">Text</span> <span class="n">text</span> <span class="o">=</span> <span class="o">(</span><span class="n">Text</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_infoText</span><span class="o">);</span>
        <span class="n">text</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">);</span>
        <span class="n">dataAbilityHelper</span> <span class="o">=</span> <span class="n">DataAbilityHelper</span><span class="o">.</span><span class="na">creator</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="c1">//查询所有联系⼈信息
</span><span class="c1"></span>        <span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&#34;dataability:///com.example.address_book.DataBaseAbility/users&#34;</span><span class="o">);</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">colums</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;userId&#34;</span><span class="o">,</span><span class="s">&#34;userName&#34;</span><span class="o">,</span><span class="s">&#34;userTel&#34;</span><span class="o">,</span><span class="s">&#34;userAddr&#34;</span><span class="o">};</span>
        <span class="n">DataAbilityPredicates</span> <span class="n">dataAbilityPredicates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataAbilityPredicates</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">dataAbilityHelper</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span><span class="n">colums</span><span class="o">,</span><span class="n">dataAbilityPredicates</span><span class="o">);</span>
            <span class="c1">//从rs中获取查询结果
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">rowCount</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getRowCount</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">rowCount</span><span class="o">&gt;</span><span class="n">0</span><span class="o">){</span>
                <span class="n">rs</span><span class="o">.</span><span class="na">goToFirstRow</span><span class="o">();</span>
                <span class="k">do</span><span class="o">{</span>
                    <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span> <span class="n">0</span><span class="o">);</span>
                    <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
                    <span class="n">String</span> <span class="n">userTel</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
                    <span class="n">String</span> <span class="n">userAddr</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
                    <span class="n">String</span> <span class="n">info</span> <span class="o">=</span> <span class="s">&#34; [&#34;</span><span class="o">+</span><span class="n">userId</span><span class="o">+</span><span class="s">&#34;,&#34;</span><span class="o">+</span><span class="n">userName</span><span class="o">+</span><span class="s">&#34;,&#34;</span><span class="o">+</span><span class="n">userTel</span><span class="o">+</span><span class="s">&#34;,&#34;</span><span class="o">+</span><span class="n">userAddr</span><span class="o">+</span><span class="s">&#34;]&#34;</span><span class="o">;</span>
                    <span class="n">text</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span> <span class="n">text</span><span class="o">.</span><span class="na">getText</span><span class="o">()+</span><span class="n">info</span> <span class="o">);</span>
                <span class="o">}</span><span class="k">while</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">goToNextRow</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">DataAbilityRemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>通过调用查询接口来查询。</li>
<li>ResultSet为查询结果集，类似于指针，指向结果的第一行。</li>
</ul>
<h2 id="结束语">结束语</h2>
<h3 id="项目源码">项目源码</h3>
<p><a href="https://github.com/leeshy-tech/HarmonyOS_example/tree/main/address_book" target="_blank" rel="noopener noreffer">https://github.com/leeshy-tech/HarmonyOS_example/tree/main/address_book</a></p>
<h3 id="参考文献">参考文献</h3>
<p><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/database-relational-overview-0000000000030046" target="_blank" rel="noopener noreffer">HarmonyOS文档——关系型数据库</a></p>
<p><a href="https://www.bilibili.com/video/BV1DM4y1G7MN" target="_blank" rel="noopener noreffer">HarmonyOS 2.0应用开发实战教程丨锋迷商城项目</a></p>
]]></description>
</item>
<item>
    <title>鸿蒙开发实践——ServiceAbility</title>
    <link>https://leeshy-tech.github.io/harmonyos_serviceability/</link>
    <pubDate>Sat, 29 Jan 2022 21:38:06 &#43;0800</pubDate><author>saili@bupt.edu.cn (Leeshy)</author><guid>https://leeshy-tech.github.io/harmonyos_serviceability/</guid>
    <description><![CDATA[<h1 id="serviceability实践">ServiceAbility实践</h1>
<h2 id="项目简介">项目简介</h2>
<h3 id="项目结构">项目结构</h3>
<pre tabindex="0"><code>├─ entry.src.main
	├─ com.example.serviceability
        ├─slice
            └─ MainAbilitySlice
        ├─ MainAbility	
        ├─ MyService
        └─ MyApplication
	├─ resources.base.layout
        └─ ability_main.xml
    └─ config.json
</code></pre><h3 id="效果">效果</h3>
<p>按钮1开启MyService。</p>
<p>按钮2连接到MyService。</p>
<p>按钮3断开与MyService的连接。</p>
<p>按钮4关闭MyService。</p>
<p>服务运行时会在状态栏显示。</p>
<p>不同的点击顺序，命令行输出的提示信息不同。</p>
<h2 id="铺垫">铺垫</h2>
<p>在MyService里的每个生命周期函数里都加一句sout来显示各个方法执行的顺序。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyService</span> <span class="kd">extends</span> <span class="n">Ability</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">HiLogLabel</span> <span class="n">LABEL_LOG</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HiLogLabel</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="n">0xD001100</span><span class="o">,</span> <span class="s">&#34;Demo&#34;</span><span class="o">);</span>

    <span class="c1">//在每个生命周期函数内加一句sout调试
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
        <span class="n">HiLog</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">LABEL_LOG</span><span class="o">,</span> <span class="s">&#34;MyService::onStart&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;--------------------onStart&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBackground</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onBackground</span><span class="o">();</span>
        <span class="n">HiLog</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">LABEL_LOG</span><span class="o">,</span> <span class="s">&#34;MyService::onBackground&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;--------------------onBackground&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStop</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onStop</span><span class="o">();</span>
        <span class="n">HiLog</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">LABEL_LOG</span><span class="o">,</span> <span class="s">&#34;MyService::onStop&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;--------------------onStop&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCommand</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">restart</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;--------------------onCommand&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">IRemoteObject</span> <span class="nf">onConnect</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;--------------------onConnect&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">LocalRemoteObject</span><span class="o">()</span> <span class="o">{};</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisconnect</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;--------------------onDisconnect&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="开启和关闭serviceability">开启和关闭ServiceAbility</h2>
<blockquote>
<p>此部分和”页面导航“里开启Ability的操作如出一辙，也就是说，我们只是在开启和关闭Ability，至于它是什么类型，无所谓。</p>
</blockquote>
<p>核心代码：</p>
<p>​	MainAbilitySlice的onStart方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//按钮1开启MyService
</span><span class="c1"></span><span class="n">Button</span> <span class="n">btn1</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn1</span><span class="o">);</span>
<span class="n">btn1</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">component</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">Intent</span> <span class="n">intent1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
    <span class="n">Operation</span> <span class="n">operation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">.</span><span class="na">OperationBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">withDeviceId</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withBundleName</span><span class="o">(</span><span class="s">&#34;com.example.serviceability&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withAbilityName</span><span class="o">(</span><span class="s">&#34;com.example.serviceability.MyService&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="n">intent1</span><span class="o">.</span><span class="na">setOperation</span><span class="o">(</span><span class="n">operation</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">startAbility</span><span class="o">(</span><span class="n">intent1</span><span class="o">);</span>
<span class="o">});</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//按钮4关闭MyService
</span><span class="c1"></span><span class="n">Button</span> <span class="n">btn4</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn4</span><span class="o">);</span>
<span class="n">btn4</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">component</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">Intent</span> <span class="n">intent3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
    <span class="n">Operation</span> <span class="n">operation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">.</span><span class="na">OperationBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">withDeviceId</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withBundleName</span><span class="o">(</span><span class="s">&#34;com.example.serviceability&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withAbilityName</span><span class="o">(</span><span class="s">&#34;com.example.serviceability.MyService&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="n">intent3</span><span class="o">.</span><span class="na">setOperation</span><span class="o">(</span><span class="n">operation</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">stopAbility</span><span class="o">(</span><span class="n">intent3</span><span class="o">);</span>
<span class="o">});</span>
</code></pre></div><ul>
<li>通过id获取Button对象，设置事件监听器。</li>
<li>调用<strong>startAbility</strong>和<strong>stopAbility</strong>方法，在intent对象的Operation属性里指定开启哪台<strong>设备</strong>的哪个<strong>应用</strong>的哪个<strong>Ability</strong>。</li>
</ul>
<h2 id="建立连接">建立连接</h2>
<p>核心代码：</p>
<p>​	MainAbilitySlice的onStart方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//按钮2连接到MyService
</span><span class="c1"></span><span class="n">Button</span> <span class="n">btn2</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn2</span><span class="o">);</span>

<span class="n">IAbilityConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IAbilityConnection</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAbilityConnectDone</span><span class="o">(</span><span class="n">ElementName</span> <span class="n">elementName</span><span class="o">,</span> <span class="n">IRemoteObject</span> <span class="n">iRemoteObject</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----------------------连接MyService成功&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAbilityDisconnectDone</span><span class="o">(</span><span class="n">ElementName</span> <span class="n">elementName</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----------------------连接MyService失败&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">};</span>

<span class="n">btn2</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">component</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">Intent</span> <span class="n">intent2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
    <span class="n">Operation</span> <span class="n">operation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">.</span><span class="na">OperationBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">withDeviceId</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withBundleName</span><span class="o">(</span><span class="s">&#34;com.example.serviceability&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withAbilityName</span><span class="o">(</span><span class="s">&#34;com.example.serviceability.MyService&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="n">intent2</span><span class="o">.</span><span class="na">setOperation</span><span class="o">(</span><span class="n">operation</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">connectAbility</span><span class="o">(</span><span class="n">intent2</span><span class="o">,</span><span class="n">connection</span><span class="o">);</span>
<span class="o">});</span>
</code></pre></div><ul>
<li>
<p>通过id获取Button对象，设置事件监听器。</p>
</li>
<li>
<p>新建连接对象，重写onAbilityConnectDone和onAbilityDisconnectDone方法，每个方法里都写一句sout用于调试。</p>
<ul>
<li>onAbilityConnectDone：连接成功建立后执行。</li>
<li>onAbilityDisconnectDone：连接建立失败后执行。</li>
</ul>
</li>
<li>
<p>调用connectAbility方法，传递intent和connect对象。</p>
</li>
</ul>
<p>​	MyService：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">IRemoteObject</span> <span class="nf">onConnect</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;--------------------onConnect&#34;</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">LocalRemoteObject</span><span class="o">()</span> <span class="o">{};</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>注意返回语句，返回一个LocalRemoteObject对象。</li>
</ul>
<p>试图与Service建立连接时，触发onConnect方法，它返回一个LocalRemoteObject对象，在这个实例中它返回的是MyService这个Ability，触发回调函数onAbilityConnectDone或者onAbilityDisconnectDone。</p>
<h2 id="关闭连接">关闭连接</h2>
<p>核心代码：</p>
<p>MainAbilitySlice的onStart方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//按钮3断开与MyService的连接
</span><span class="c1"></span><span class="n">Button</span> <span class="n">btn3</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn3</span><span class="o">);</span>
<span class="n">btn3</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">component</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">disconnectAbility</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div><ul>
<li>若connection对象存在，就调用<strong>disconnectAbility</strong>方法即可。</li>
</ul>
<h2 id="前台service">前台Service</h2>
<p>前台Service会始终保持正在运行的图标在系统状态栏显示。</p>
<p>核心代码：</p>
<p>MyService的onStart方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 创建通知，其中1005为notificationId
</span><span class="c1"></span><span class="n">NotificationRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NotificationRequest</span><span class="o">(</span><span class="n">1005</span><span class="o">);</span>
<span class="n">NotificationRequest</span><span class="o">.</span><span class="na">NotificationNormalContent</span> <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NotificationRequest</span><span class="o">.</span><span class="na">NotificationNormalContent</span><span class="o">();</span>
<span class="n">content</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">).</span><span class="na">setText</span><span class="o">(</span><span class="s">&#34;text&#34;</span><span class="o">);</span>
<span class="n">NotificationRequest</span><span class="o">.</span><span class="na">NotificationContent</span> <span class="n">notificationContent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NotificationRequest</span><span class="o">.</span><span class="na">NotificationContent</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">notificationContent</span><span class="o">);</span>

<span class="c1">// 绑定通知，1005为创建通知时传入的notificationId
</span><span class="c1"></span><span class="n">keepBackgroundRunning</span><span class="o">(</span><span class="n">1005</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
</code></pre></div><p>这段进行一个简单的Ctrl+C、V就行，注意以下几个点：</p>
<ul>
<li>
<p>1005这个notificationId不能与其他的服务重复</p>
</li>
<li>
<p>title和text在图中对应：</p>
<p></p>
</li>
</ul>
<p>config.json中还要申请常驻后台权限：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="s2">&#34;reqPermissions&#34;</span><span class="err">:</span> <span class="p">[</span>
  <span class="p">{</span><span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ohos.permission.KEEP_BACKGROUND_RUNNING&#34;</span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div><p>位置如图所示：</p>
<p></p>
<h2 id="生命周期分析">生命周期分析</h2>
<p>整个执行过程如图所示：</p>
<p></p>
<ul>
<li>
<p>启动：</p>
<ul>
<li>
<p>若MyService已建立，执行onCommand。</p>
<p></p>
</li>
<li>
<p>若未建立，执行onStart和onCommand。</p>
<p></p>
</li>
</ul>
</li>
<li>
<p>连接：</p>
<ul>
<li>
<p>若MyService已建立，则执行onConnect。</p>
<p></p>
</li>
<li>
<p>若未建立，则执行onStart和onConnect（红字忽略）。</p>
<p></p>
</li>
</ul>
</li>
<li>
<p>断开连接：当连接存在，且</p>
<ul>
<li>
<p>MyService是手动创建的，不是由连接唤起的，只执行onDisconnect</p>
<p></p>
</li>
<li>
<p>MyService是由该连接唤起的，执行onDisconnect、onBackground、onStop。</p>
<p></p>
</li>
</ul>
</li>
<li>
<p>关闭：当MyService没有被连接时，才能关闭，执行onBackground和onStop。</p>
<p></p>
</li>
</ul>
<h2 id="结束语">结束语</h2>
<h3 id="项目源码">项目源码</h3>
<p><a href="https://github.com/leeshy-tech/HarmonyOS_example/tree/main/ServiceAbility" target="_blank" rel="noopener noreffer">https://github.com/leeshy-tech/HarmonyOS_example/tree/main/ServiceAbility</a></p>
<h3 id="参考文献">参考文献</h3>
<p><a href="https://www.bilibili.com/video/BV1DM4y1G7MN" target="_blank" rel="noopener noreffer">HarmonyOS 2.0应用开发实战教程丨锋迷商城项目</a></p>
<p><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/ability-service-concept-0000000000044457" target="_blank" rel="noopener noreffer">HarmonyOS文档——ServiceAbility</a></p>
]]></description>
</item>
<item>
    <title>鸿蒙开发实践——页面导航</title>
    <link>https://leeshy-tech.github.io/harmonyos_pagetopage/</link>
    <pubDate>Fri, 28 Jan 2022 23:32:06 &#43;0800</pubDate><author>saili@bupt.edu.cn (Leeshy)</author><guid>https://leeshy-tech.github.io/harmonyos_pagetopage/</guid>
    <description><![CDATA[<h1 id="页面导航">页面导航</h1>
<h2 id="项目简介">项目简介</h2>
<h3 id="项目结构">项目结构</h3>
<pre tabindex="0"><code>├─ entry.src.main
	├─ com.example.page_to_page
        ├─slice
            ├─ AnotherAbilitySlice
            ├─ MainAbilitySlice
            └─ SecondAbilitySlice
        ├─ AnotherAbility	
        ├─ MainAbility
        └─ MyApplication
	└─ resources.base.layout
        ├─ ability_another.xml
        ├─ ability_main.xml
        └─ ability_second.xml
</code></pre><h3 id="效果">效果</h3>
<p>点击按钮一，从MainAbilitySlice跳转到SecondAbilitySlice。</p>
<p>点击按钮二，从MainAbilitySlice跳转到SecondAbilitySlice，并传递参数字符串。</p>
<p>点击按钮三，从MainAbility的MainAbilitySlice跳转到AnotherAbility的AnotherAbilitySlice。</p>
<p></p>
<h2 id="intent">intent</h2>
<blockquote>
<p><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/ability-intent-0000000000038799" target="_blank" rel="noopener noreffer">HarmonyOS文档——intent</a></p>
</blockquote>
<p>intent是对象之间传递信息的载体，Slice之间的导航、传参以及Ability之间的导航都是基于intent。Intent的构成元素包括Operation与Parameters。Operation是执行的操作，Parameters则是携带的参数。</p>
<h2 id="slice间导航">Slice间导航</h2>
<p>核心代码：</p>
<p>MainAbilitySlice的onStart方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="n">Button</span> <span class="n">btn1</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn1</span><span class="o">);</span>
<span class="n">btn1</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">present</span><span class="o">(</span><span class="k">new</span> <span class="n">SecondAbilitySlice</span><span class="o">(),</span><span class="k">new</span> <span class="n">Intent</span><span class="o">()));</span>
</code></pre></div><ul>
<li>通过id获取按钮对象。</li>
<li>给按钮绑定事件监听器，执行present方法。</li>
<li>这里只是导航，没有其他操作，所以传递一个默认intent即可。</li>
</ul>
<h2 id="slice间传参">Slice间传参</h2>
<p>核心代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="n">Button</span> <span class="n">btn2</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn2</span><span class="o">);</span>
<span class="n">btn2</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">listener</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">Intent</span> <span class="n">intent1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
    <span class="n">intent1</span><span class="o">.</span><span class="na">setParam</span><span class="o">(</span><span class="s">&#34;my_string&#34;</span><span class="o">,</span><span class="s">&#34;从MainAbilitySlice传参&#34;</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">present</span><span class="o">(</span><span class="k">new</span> <span class="n">SecondAbilitySlice</span><span class="o">(),</span><span class="n">intent1</span><span class="o">);</span>
<span class="o">});</span>
</code></pre></div><p>跟导航部分思路相同。</p>
<p>传参的关键是构造intent对象的Parameters属性，使用setParam方法存储键值对。setParam方法有很多重载，包括int，string等等，但是没有对象类型，也就是传参不能传对象。</p>
<h2 id="pageability间导航">PageAbility间导航</h2>
<p>核心代码：</p>
<p>MainAbilitySlice类的onStart方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="n">Button</span> <span class="n">btn3</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findComponentById</span><span class="o">(</span><span class="n">ResourceTable</span><span class="o">.</span><span class="na">Id_btn3</span><span class="o">);</span>
<span class="n">btn3</span><span class="o">.</span><span class="na">setClickedListener</span><span class="o">(</span><span class="n">listener</span> <span class="o">-&gt;</span> <span class="n">navigateToAnotherPage</span><span class="o">(</span><span class="n">listener</span><span class="o">));</span>
</code></pre></div><p>设置监听器的逻辑相同，不过这次我们让监听器执行我们的自定义函数navigateToAnotherPage。</p>
<p>MainAbilitySlice类新增:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">navigateToAnotherPage</span><span class="o">(</span><span class="n">Component</span> <span class="n">component</span><span class="o">){</span>
        <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
        <span class="n">Operation</span> <span class="n">operation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">.</span><span class="na">OperationBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withDeviceId</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">)</span>						<span class="c1">//空字符串为本机
</span><span class="c1"></span>                <span class="o">.</span><span class="na">withBundleName</span><span class="o">(</span><span class="s">&#34;com.example.page_to_page&#34;</span><span class="o">)</span><span class="c1">//本应用的标识
</span><span class="c1"></span>                <span class="o">.</span><span class="na">withAbilityName</span><span class="o">(</span><span class="s">&#34;com.example.page_to_page.AnotherAbility&#34;</span><span class="o">)</span><span class="c1">//想启动的Ability
</span><span class="c1"></span>                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="n">intent</span><span class="o">.</span><span class="na">setOperation</span><span class="o">(</span><span class="n">operation</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">startAbility</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div><ul>
<li>使用OperationBuilder构建一个Operation，设置给intent。</li>
<li>将intent传给监听器</li>
</ul>
<p>页面跳转的核心是intent对象的Operation属性，这里构建Operation有三个参数DeviceId、BundleName、AbilityName，因为鸿蒙可以启动任意设备的任意应用的任意Ability，可能这就是万物互联吧。</p>
<h2 id="结束语">结束语</h2>
<h3 id="项目源码">项目源码</h3>
<p><a href="https://github.com/leeshy-tech/HarmonyOS_example/tree/main/page_to_page" target="_blank" rel="noopener noreffer">https://github.com/leeshy-tech/HarmonyOS_example/tree/main/page_to_page</a></p>
<h3 id="参考文献">参考文献</h3>
<p><a href="https://www.bilibili.com/video/BV1DM4y1G7MN" target="_blank" rel="noopener noreffer">HarmonyOS 2.0应用开发实战教程丨锋迷商城项目</a></p>
<p><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/ability-intent-0000000000038799" target="_blank" rel="noopener noreffer">HarmonyOS文档——intent</a></p>
]]></description>
</item>
<item>
    <title>鸿蒙开发笔记——开发工具DevEco Studio</title>
    <link>https://leeshy-tech.github.io/harmonyos_studioconfig/</link>
    <pubDate>Fri, 28 Jan 2022 17:21:06 &#43;0800</pubDate><author>saili@bupt.edu.cn (Leeshy)</author><guid>https://leeshy-tech.github.io/harmonyos_studioconfig/</guid>
    <description><![CDATA[<h1 id="deveco-studio">DevEco Studio</h1>
<blockquote>
<p>HUAWEI DevEco Studio（获取工具请<a href="https://developer.harmonyos.com/cn/develop/deveco-studio" target="_blank" rel="noopener noreffer">点击链接下载</a>，以下简称DevEco Studio）是基于IntelliJ IDEA Community开源版本打造，面向华为终端全场景多设备的一站式集成开发环境（IDE），为开发者提供工程模板创建、开发、编译、调试、发布等E2E的HarmonyOS应用/服务开发</p>
</blockquote>
<h2 id="配置">配置</h2>
<p>DevEco是基于IDEA打造的，所以二者非常相似，有些配置不会的话可以直接google IDEA的相关配置。</p>
<h3 id="界面风格">界面风格</h3>
<blockquote>
<p>将界面风格改为暗黑模式</p>
</blockquote>
<ul>
<li>
<p>打开设置：file&gt;settings</p>
</li>
<li>
<p>Appearance &amp; Behavior &gt; Appearance</p>
</li>
<li>
<p>Theme：改为Darcula，点击OK。</p>
<p></p>
</li>
</ul>
<h3 id="字体">字体</h3>
<ul>
<li>
<p>打开设置：file&gt;settings</p>
</li>
<li>
<p>Editor &gt; Font</p>
</li>
<li>
<p>Font：字体风格，我个人比较喜欢Inconsolata ; Size：字号 ; Line height：行距</p>
</li>
</ul>
<p></p>
<h3 id="注释颜色">注释颜色</h3>
<blockquote>
<p>初始的注释颜色非常浅，还是灰色，所以想调成亮一点的绿色。</p>
</blockquote>
<ul>
<li>
<p>打开设置：file&gt;settings</p>
</li>
<li>
<p>Editor &gt; Color Scheme &gt; Language Default</p>
</li>
<li>
<p>点开Comments，其中Block comment是块注释，Line comment是行注释，尽量二者颜色统一吧，颜色栏是可以复制的。</p>
</li>
</ul>
<p></p>
<h3 id="输入联想大小写不敏感">输入联想——大小写不敏感</h3>
<blockquote>
<p>初始的输入联想是大小写敏感的，Str才能补全成String，设置大小写不敏感，使str也能补全成String。</p>
</blockquote>
<ul>
<li>打开设置：file&gt;settings</li>
<li>Editor &gt; General &gt; Code Completion</li>
<li>去掉右侧Match case的勾</li>
</ul>
<p></p>
<p>效果如下：</p>
<p></p>
<h3 id="自动引包优化">自动引包优化</h3>
<ul>
<li>
<p>打开设置：file&gt;settings</p>
</li>
<li>
<p>Editor &gt; General &gt; Auto import</p>
</li>
<li>
<p>在右侧勾上如图的两句话。</p>
<p></p>
</li>
</ul>
<h3 id="汉化">汉化</h3>
<blockquote>
<p>编辑器设中文其实意义不大，汉化部分很少，都是一些基础的单词，但是我看到中文有一种莫名的安心感，所以还是汉化了。</p>
</blockquote>
<ul>
<li>打开设置：file&gt;settings</li>
<li>Plugins</li>
<li>搜索chinese，在installed里找到Chinese (Simplified) ，点击enable。</li>
<li>注意你会在Marketplace里找到Chinese (Simplified) Language Pack，它是IDEA的插件，适配效果没有内置的好。</li>
</ul>
<p></p>
<h2 id="项目结构">项目结构</h2>
<h2 id="调试方法">调试方法</h2>
<p>鸿蒙项目有两种调试方式：previewer和在设备运行</p>
<h4 id="previewer">Previewer</h4>
<p>previewer本质上是个页面预览器，预览的页面是工作区前台的Page。位置在：</p>
<p></p>
<h4 id="在设备运行">在设备运行</h4>
<p>设备有很多种，本地模拟器、远程模拟器、远程真机等等（<a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/run_simulator-0000001053303709" target="_blank" rel="noopener noreffer">细节可以看官方文档</a>），都是将整个项目完整的打包成应用在设备上运行。推荐使用远程模拟器，因为本地模拟器会占用相当大一部分的本机资源。在右上角打开设备管理器即可进行管理。</p>
<p></p>
<h3 id="选择调试方式">选择调试方式</h3>
<p>设备：不管是远程还是本地，使用上都会有一定的卡顿，并且项目具有默认显示页面，调试非默认页面时，需要保证跳转逻辑等等无误。</p>
<p>预览器：工作区打开什么文件就默认预览什么文件，不需要考虑其他页面或者Ability的逻辑，但是，预览器是高度阉割的，某些逻辑不能很好的在预览器运行，比如我昨天遇到一个报错`[ClassCastException: java.lang.Object cannot be cast to java.lang.String，在预览器中运行就会报这个错误无法启动预览器，但是在设备中运行就正常。所以要灵活选择调试方式。当然，不提供页面服务的Ability的肯定要在设备上测试。</p>
<h2 id="结束语">结束语</h2>
<h3 id="参考文献">参考文献</h3>
]]></description>
</item>
</channel>
</rss>
